---

- name: Reset Kubernetes component
  shell: "kubeadm reset --force"
  register: reset_cluster
      
- name: Get SHA hash value
  when: reset_cluster is succeeded
  shell: echo sha256:$(openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //')
  register: sha_hash

# - name: Echo command
#   when: sha_hash is defined
#   shell: "echo kubeadm join --token {{ token }} --ignore-preflight-errors=all --discovery-token-ca-cert-hash {{ sha_hash.stdout }} {{ master_ip }}:{{ kube_port }}"
#   register: comm

# - debug:
#     msg: "{{ comm }}"

- name: Join to Kubernetes cluster
  when: sha_hash is defined
  shell: "kubeadm join --token {{ token }} --ignore-preflight-errors=all --discovery-token-ca-cert-hash {{ sha_hash.stdout }} {{ master_ip }}:{{ kube_port }}"
  register: join_cluster
  notify:
    - Recreate kube-dns
